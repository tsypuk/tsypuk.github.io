<!doctype html><html lang="en" ><head> <script async src="https://www.googletagmanager.com/gtag/js?id=G-LXECFRDHS1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-LXECFRDHS1'); </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="AWS XRAY tracing. Part 3: Sampling &amp; Billing | by Roman Tsypuk" /><meta name="author" content="Roman Tsypuk" /><meta property="og:locale" content="en" /><meta name="description" content="AWS x-ray Sampling allows defining traces recording behavior (rate of traces per-second, predicates to filter what traces to record, etc.) Applying different sampling configurations we can set different rates of traces recording on different environments, target specific user/organization/service that requires more/less detailed tracing recording. And of course by setting the sampling rates we can control xray service billing, because it is related with recorded and scanned traces requests." /><meta property="og:description" content="AWS x-ray Sampling allows defining traces recording behavior (rate of traces per-second, predicates to filter what traces to record, etc.) Applying different sampling configurations we can set different rates of traces recording on different environments, target specific user/organization/service that requires more/less detailed tracing recording. And of course by setting the sampling rates we can control xray service billing, because it is related with recorded and scanned traces requests." /><meta property="twitter:description" content="AWS x-ray Sampling allows defining traces recording behavior (rate of traces per-second, predicates to filter what traces to record, etc.) Applying different sampling configurations we can set different rates of traces recording on different environments, target specific user/organization/service that requires more/less detailed tracing recording. And of course by setting the sampling rates we can control xray service billing, because it is related with recorded and scanned traces requests." /><link rel="canonical" href="https://tsypuk.github.io/posts/2023/03/27/xra-tracing-3.html" /><meta property="og:url" content="https://tsypuk.github.io/posts/2023/03/27/xra-tracing-3.html" /><meta property="og:site_name" content="Engineer’s Notes | Roman Tsypuk" /><meta property="og:image" content="https://tsypuk.github.io/images/banners/1200/pexels-polina-tankilevitch-3735709.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-27T17:00:00+03:00" /><meta name="publish_date" property="og:publish_date" content="2023-03-27T17:00:00+03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://tsypuk.github.io/images/banners/1200/pexels-polina-tankilevitch-3735709.jpeg" /><meta property="twitter:title" content="AWS XRAY tracing. Part 3: Sampling &amp; Billing | by Roman Tsypuk" /><meta name="twitter:site" content="@roman_tsypuk" /><meta name="twitter:creator" content="@roman_tsypuk" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Roman Tsypuk"},"dateModified":"2024-03-05T20:31:17+02:00","datePublished":"2023-03-27T17:00:00+03:00","description":"AWS x-ray Sampling allows defining traces recording behavior (rate of traces per-second, predicates to filter what traces to record, etc.) Applying different sampling configurations we can set different rates of traces recording on different environments, target specific user/organization/service that requires more/less detailed tracing recording. And of course by setting the sampling rates we can control xray service billing, because it is related with recorded and scanned traces requests.","headline":"AWS XRAY tracing. Part 3: Sampling &amp; Billing","image":"https://tsypuk.github.io/images/banners/1200/pexels-polina-tankilevitch-3735709.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsypuk.github.io/posts/2023/03/27/xra-tracing-3.html"},"url":"https://tsypuk.github.io/posts/2023/03/27/xra-tracing-3.html"}</script><title>AWS XRAY tracing. Part 3: Sampling & Billing | Engineer's Notes</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Engineer's Notes"><meta name="application-name" content="Engineer's Notes"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LXECFRDHS1"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-LXECFRDHS1'); }); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/images/avatar/rtsypuk.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Engineer's Notes</a><p class="site-subtitle fst-italic mb-0">Cloud, Infrastructure, Architecture, Networking</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories.html" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags.html" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archived_posts.html" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/roman_tsypuk.html" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tsypuk" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/roman_tsypuk" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/roman-tsypuk" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['tsypuk_conf','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>AWS XRAY tracing. Part 3: Sampling & Billing</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>AWS XRAY tracing. Part 3: Sampling & Billing</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1679925600" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 27, 2023 </time> </span> <span> Updated <time data-ts="1709663477" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 5, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/images/banners/1200/pexels-polina-tankilevitch-3735709.jpeg" class="popup img-link preview-img shimmer"><img src="/images/banners/1200/pexels-polina-tankilevitch-3735709.jpeg" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/roman-tsypuk">Roman Tsypuk</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="990 words" > <em>5 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">AWS XRAY tracing. Part 3: Sampling & Billing</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">AWS XRAY tracing. Part 3: Sampling & Billing</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="abstract"><span class="me-2">Abstract</span><a href="#abstract" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>AWS x-ray Sampling allows defining traces recording behavior (rate of traces per-second, predicates to filter what traces to record, etc.) Applying different sampling configurations we can set different rates of traces recording on different environments, target specific user/organization/service that requires more/less detailed tracing recording.</p><p>And of course by setting the sampling rates we can control xray service billing, because it is related with recorded and scanned traces requests.</p><p>Link to <a href="/posts/2023/03/01/xra-tracing.html">AWS XRAY tracing. Part 1: Foundational</a></p><p>Link to <a href="/posts/2023/03/21/xra-tracing-2.html">AWS XRAY tracing. Part 2: Advanced: Querying &amp; Grouping</a></p><h2 id="sampling"><span class="me-2">Sampling</span><a href="#sampling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>By utilizing sampling, you can manage the size of traces that are captured and stored, while also providing the flexibility to adjust the sampling behavior without the necessity of redeploying or modifying your code.</p><p>The <code class="language-plaintext highlighter-rouge">default configuration</code>: record the <code class="language-plaintext highlighter-rouge">initial request</code> <code class="language-plaintext highlighter-rouge">every second</code> and an additional <code class="language-plaintext highlighter-rouge">5%</code> of the requests beyond that. The reservoir contains 1 res/sec to ensure that the service records <code class="language-plaintext highlighter-rouge">at least one trace per second</code> while serving requests.</p><p>This is trace sampling monitor from aws console for Default Sampling rule, that almost in realtime shows sampling rates fo traces that are ingested into the system:</p><p><a href="/images/posts/xray3/sampling.png" class="popup img-link shimmer"><img src="/images/posts/xray3/sampling.png" alt="img.png" loading="lazy"></a></p><p>When creating Sampling Rule, we can narrow down the set of traces for which sampling configuration is defined. Matching Criteria can be combined with the following predicates:</p><ul><li>service name<li>service type<li>host<li>resourceARN<li>HTTPMethod<li>URLPath<li>Annotations</ul><p>So we can create distinct sampling configurations based on endpoint, particular annotation value present in the trace, host, name, etc. The traces that are following these defined predicates will be recorded based on their own custom defined rates.</p><h3 id="sampling-setup-from-aws-cli"><span class="me-2">Sampling setup from aws cli</span><a href="#sampling-setup-from-aws-cli" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>AWS cli support CRUD operations with sampling rules:</p><ul><li>aws xray get-sampling-rules<li>aws xray update-sampling-rule<li>aws xray create-sampling-rule<li>aws xray delete-sampling-rule</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre> aws xray get-sampling-rules
<span class="o">{</span>
    <span class="s2">"SamplingRuleRecords"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"SamplingRule"</span>: <span class="o">{</span>
                <span class="s2">"RuleName"</span>: <span class="s2">"Default"</span>,
                <span class="s2">"RuleARN"</span>: <span class="s2">"arn:aws:xray:eu-central-1:xxxxxx:sampling-rule/Default"</span>,
                <span class="s2">"ResourceARN"</span>: <span class="s2">"*"</span>,
                <span class="s2">"Priority"</span>: 10000,
                <span class="s2">"FixedRate"</span>: 0.05,
                <span class="s2">"ReservoirSize"</span>: 1,
                <span class="s2">"ServiceName"</span>: <span class="s2">"*"</span>,
                <span class="s2">"ServiceType"</span>: <span class="s2">"*"</span>,
                <span class="s2">"Host"</span>: <span class="s2">"*"</span>,
                <span class="s2">"HTTPMethod"</span>: <span class="s2">"*"</span>,
                <span class="s2">"URLPath"</span>: <span class="s2">"*"</span>,
                <span class="s2">"Version"</span>: 1,
                <span class="s2">"Attributes"</span>: <span class="o">{}</span>
            <span class="o">}</span>,
            <span class="s2">"CreatedAt"</span>: 0.0,
            <span class="s2">"ModifiedAt"</span>: 0.0
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="sampling-for-detailed-troubleshooting-during-incident-window"><span class="me-2">Sampling for detailed troubleshooting during Incident Window</span><a href="#sampling-for-detailed-troubleshooting-during-incident-window" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>One of sampling practical use-cases is a detailed troubleshooting. We can <code class="language-plaintext highlighter-rouge">TURN ON</code> particular sampling rule for the short period of time only while we are actively troubleshooting (Incident Window) dedicated user/instance (defined in the predicate of sampling rule) issue to gather traces. After recording is finished we can <code class="language-plaintext highlighter-rouge">TURN OFF</code> this sampling rule, since traces are already persisted and ready for offline analysis.</p><p>Here, we are creating one Sampling configuration called <code class="language-plaintext highlighter-rouge">user_with_error</code>, it includes traces for dedicated user and IP with a fixed rate 100%. So all traces that are following these criteria will be recorded.</p><p>We can create up to 25 custom sampling rules in addition to Default rule and observer all of them from aws console. Each of them has own monitor with priority, matching criteria, limit details and Trend graph:</p><p><a href="/images/posts/xray3/sampling_error_user.png" class="popup img-link shimmer"><img src="/images/posts/xray3/sampling_error_user.png" alt="img.png" loading="lazy"></a></p><h3 id="sampling-configuration-in-aws-lambda-function"><span class="me-2">Sampling configuration in aws lambda function</span><a href="#sampling-configuration-in-aws-lambda-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Also, we can customize sampling rules by including sampling JSON configuration directly inside lambda function.</p><p>There are several strategies to instrument lambda sampling behavior:</p><ul><li><code class="language-plaintext highlighter-rouge">NewCentralizedStrategyWithFilePath</code> will first access xray service to get sampling configuration, if any issue will fall back to locally provided config<li><code class="language-plaintext highlighter-rouge">NewLocalizedStrategyFromFilePath</code> will always use only local (pre-built into lambda) sampling rules configuration.</ul><p>To update AWS lambda with custom sampling configuration we need to go through following steps:</p><ul><li><p>Create sampling rules configuration JSON</p><div file="sampling.json" class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="sampling.json"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"rules"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Updated Sampling Rules"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"http_method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url_path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"fixed_target"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"rate"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.05</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"fixed_target"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rate"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.1</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><li><p>Sampling rules configuration file should be included both with binary into aws lambda assembly (if zip command is in use for packaging it should be updated):</p><div file="package.sh" class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="package.sh"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>...
  zip main.zip main ../../sampling/sampling.json
...
</pre></table></code></div></div><li><p>Update Lambda’s init function and configure with proper sampling strategy.</p><div file="lambda_function/main.go" class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="lambda_function/main.go"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">samplingStrategy</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">sampling</span><span class="o">.</span><span class="n">NewCentralizedStrategyWithFilePath</span><span class="p">(</span><span class="s">"sampling/sampling.json"</span><span class="p">)</span>
  <span class="n">xray</span><span class="o">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">xray</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span>
    <span class="n">SamplingStrategy</span><span class="o">:</span> <span class="n">samplingStrategy</span><span class="p">,</span>
    <span class="n">ServiceVersion</span><span class="o">:</span>   <span class="s">"1.2.3"</span><span class="p">,</span>
  <span class="p">})</span>
  <span class="n">newSession</span> <span class="o">:=</span> <span class="n">session</span><span class="o">.</span><span class="n">Must</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">NewSession</span><span class="p">())</span>
  <span class="n">ses</span> <span class="o">=</span> <span class="n">newSession</span>
<span class="p">}</span>
</pre></table></code></div></div></ul><h3 id="sampling-for-billing-control"><span class="me-2">Sampling for Billing control</span><a href="#sampling-for-billing-control" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>By utilizing sampling rules, we have the ability to specify distinct traces recording settings that correspond to various types of environments. This is particularly important as there is a correlation between amount of recorded traces and billing, which allows for the regulation of costs.</p><p>Here is a trace recording calculation for generic application with different sampling rate (SR) configurations and same rate of Requests Per Hour (RPH).</p><h4 id="application-setup-20000-rph-samplingrate-10"><span class="me-2">application setup: <code class="language-plaintext highlighter-rouge">20000 RPH</code>, <code class="language-plaintext highlighter-rouge">SamplingRate: 10%</code></span><a href="#application-setup-20000-rph-samplingrate-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><hr /><p><strong>Traces Recorded per Month</strong> = 20000 requests per hour x 24 hours x 31 days x 10% = 1 488 000 traces</p><p><strong>Billable Traces Recorded per Month</strong> = 1 488 000 traces - 100,000 traces (free tier) = 1 388 000 traces</p><p><strong>Monthly Traces Recorded Charges</strong> = 1 388 000 traces * $0.000005 = <code class="language-plaintext highlighter-rouge">$6.94</code></p><hr /><h4 id="application-setup-20000-rph-samplingrate-1"><span class="me-2">application setup: <code class="language-plaintext highlighter-rouge">20000 RPH</code>, <code class="language-plaintext highlighter-rouge">SamplingRate: 1%</code></span><a href="#application-setup-20000-rph-samplingrate-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><hr /><p><strong>Traces Recorded per Month</strong> = 20000 requests per hour x 24 hours x 31 days x 1% = 148 800 traces</p><p><strong>Billable Traces Recorded per Month</strong> = 148 800 traces - 100,000 traces (free tier) = 38 800 traces</p><p><strong>Monthly Traces Recorded Charges</strong> = 38 800 traces * $0.000005 = <code class="language-plaintext highlighter-rouge">$0.192</code></p><hr /><h2 id="overall-x-ray-billing"><span class="me-2">Overall x-ray Billing</span><a href="#overall-x-ray-billing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>AWS xray billing is combined of Free Tier buffer and on top requests that are billed.</p><p>There are 4 trace access patterns that are billed and calculated with different charge and rates:</p><ul><li>traces recorded<li>traces scanned<li>traces retrieved<li>traces insights (newly added xray feature)</ul><h3 id="free-tier"><span class="me-2">Free Tier</span><a href="#free-tier" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>The first 100,000 traces recorded each month are free.<li>The first 1,000,000 traces retrieved or scanned each month are free.</ul><p>Everything on top of Free Tier is billed, pricing is specific to the AWS region, you can check the details and sampled calculator on <a href="https://aws.amazon.com/xray/pricing/">XRAY pricing</a></p><h2 id="references-links"><span class="me-2">References (Links)</span><a href="#references-links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://docs.aws.amazon.com/xray/latest/devguide/xray-console-sampling.html">XRAY sampling</a><li><a href="https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-go-configuration.html">XRAY configuring GO SDK</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/aws/">aws</a>, <a href="/categories/xray/">xray</a>, <a href="/categories/monitoring/">monitoring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/xray/" class="post-tag no-text-decoration" >xray</a> <a href="/tags/monitoring/" class="post-tag no-text-decoration" >monitoring</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AWS%20XRAY%20tracing.%20Part%203:%20Sampling%20&%20Billing%20-%20Engineer's%20Notes&url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F03%2F27%2Fxra-tracing-3.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AWS%20XRAY%20tracing.%20Part%203:%20Sampling%20&%20Billing%20-%20Engineer's%20Notes&u=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F03%2F27%2Fxra-tracing-3.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F03%2F27%2Fxra-tracing-3.html&text=AWS%20XRAY%20tracing.%20Part%203:%20Sampling%20&%20Billing%20-%20Engineer's%20Notes" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F03%2F27%2Fxra-tracing-3.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/2025/09/26/multiagnet-n8n-bedrock.html">Orchestrating AI multi-agent infrastructure with AWS Bedrock, OpenAI and n8n</a><li class="text-truncate lh-lg"> <a href="/posts/2025/07/20/elastic-cache-vector.html">Amazon ElastiCache Redis as a Vector Embeddings Storage for Semantic Search in AWS Community Blog posts</a><li class="text-truncate lh-lg"> <a href="/posts/2025/09/17/duckdb-s3.html">Running analytics queries from your machine with Zero-BigData stack needed on top of AWS S3(compressed JSON, Parquet, csv) or other DataSources</a><li class="text-truncate lh-lg"> <a href="/posts/2023/10/02/dynamo-design.html">DynamoDB Table Design Principles - NoSQL Modeling</a><li class="text-truncate lh-lg"> <a href="/posts/2023/10/04/dynamo-one-to-many.html">DynamoDB Table Design Principles - One-To-Many Relationships in NoSQL</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/dynamodb/">dynamodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/s3/">s3</a> <a class="post-tag btn btn-outline-primary" href="/tags/ecs/">ecs</a> <a class="post-tag btn btn-outline-primary" href="/tags/network/">network</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli/">cli</a> <a class="post-tag btn btn-outline-primary" href="/tags/fargate/">fargate</a> <a class="post-tag btn btn-outline-primary" href="/tags/firehose/">firehose</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/2023/03/21/xra-tracing-2.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1679407200" data-df="ll" > Mar 21, 2023 </time><h4 class="pt-0 my-2">AWS XRAY tracing. Part 2: Advanced. Querying & Grouping.</h4><div class="text-muted"><p>Abstract Welcome to the next part of our AWS X-Ray series. We’ll explore the flow of trace detection and how to specify different parameters like time ranges. Additionally, we’ll take a deep dive i...</p></div></div></a></article><article class="col"> <a href="/posts/2023/03/01/xra-tracing.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1677646800" data-df="ll" > Mar 1, 2023 </time><h4 class="pt-0 my-2">AWS XRAY tracing. Part 1: Foundational</h4><div class="text-muted"><p>Abstract Having used AWS xray for a while now, I can attest to its effectiveness as a tracing and monitoring service. It has saved me a significant amount of time, helped troubleshoot complex issu...</p></div></div></a></article><article class="col"> <a href="/posts/2023/03/07/mingrammer.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1678165200" data-df="ll" > Mar 7, 2023 </time><h4 class="pt-0 my-2">Diagrams-as-a-Code DaC with Mingrammer for Public Cloud Providers and Agnostic Stacks.</h4><div class="text-muted"><p>Abstract During my analysis of open-source libraries that are suitable for rendering AWS components, in order to simplify the understanding and documenting of application architecture I discovered ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/2023/03/26/jekyl-plugin.html" class="btn btn-outline-primary" aria-label="Older" ><p>Developing plugin for Jekyll</p></a> <a href="/posts/2023/04/02/costs.html" class="btn btn-outline-primary" aria-label="Newer" ><p>AWS Costs optimization Tools and Frameworks: Extract from AWS Series</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://www.linkedin.com/in/roman-tsypuk">Roman Tsypuk</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span> <span data-bs-toggle="tooltip" data-bs-placement="top" title="2025-09-26 20:11:52 +0300 &#013;be60bb44e6416aa69b8fd68791db025be40c523c">Build version: be60bb4</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/dynamodb/">dynamodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/s3/">s3</a> <a class="post-tag btn btn-outline-primary" href="/tags/ecs/">ecs</a> <a class="post-tag btn btn-outline-primary" href="/tags/network/">network</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli/">cli</a> <a class="post-tag btn btn-outline-primary" href="/tags/fargate/">fargate</a> <a class="post-tag btn btn-outline-primary" href="/tags/firehose/">firehose</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'tsypuk/tsypuk.github.io', 'data-repo-id': 'R_kgDOIxaFiw', 'data-category': 'General', 'data-category-id': 'DIC_kwDOIxaFi84CUSfn', 'data-mapping': 'og:title', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'top', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
