<!doctype html><html lang="en" ><head> <script async src="https://www.googletagmanager.com/gtag/js?id=G-LXECFRDHS1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-LXECFRDHS1'); </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Connecting Kinesis Firehose DataStream with aws-kinesis-agent to ingest Log Data into AWS S3 | by Roman Tsypuk" /><meta name="author" content="Roman Tsypuk" /><meta property="og:locale" content="en" /><meta name="description" content="AWS Kinesis Firehose is a powerful service that enables almost real-time data streaming at scale. It simplifies the process of ingesting, transforming, and loading large volumes of data into various AWS services. In this guide, we’ll explore what Kinesis Firehose is, its key features, and how you can leverage it for your data processing needs." /><meta property="og:description" content="AWS Kinesis Firehose is a powerful service that enables almost real-time data streaming at scale. It simplifies the process of ingesting, transforming, and loading large volumes of data into various AWS services. In this guide, we’ll explore what Kinesis Firehose is, its key features, and how you can leverage it for your data processing needs." /><meta property="twitter:description" content="AWS Kinesis Firehose is a powerful service that enables almost real-time data streaming at scale. It simplifies the process of ingesting, transforming, and loading large volumes of data into various AWS services. In this guide, we’ll explore what Kinesis Firehose is, its key features, and how you can leverage it for your data processing needs." /><link rel="canonical" href="https://tsypuk.github.io/posts/2023/10/18/kineses-firehose.html" /><meta property="og:url" content="https://tsypuk.github.io/posts/2023/10/18/kineses-firehose.html" /><meta property="og:site_name" content="Engineer’s Notes | Roman Tsypuk" /><meta property="og:image" content="https://tsypuk.github.io/images/banners/1200/pexels-anna-shvets-5965217.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-10-18T17:00:00+03:00" /><meta name="publish_date" property="og:publish_date" content="2023-10-18T17:00:00+03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://tsypuk.github.io/images/banners/1200/pexels-anna-shvets-5965217.jpeg" /><meta property="twitter:title" content="Connecting Kinesis Firehose DataStream with aws-kinesis-agent to ingest Log Data into AWS S3 | by Roman Tsypuk" /><meta name="twitter:site" content="@roman_tsypuk" /><meta name="twitter:creator" content="@roman_tsypuk" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Roman Tsypuk"},"dateModified":"2024-02-25T18:38:06+02:00","datePublished":"2023-10-18T17:00:00+03:00","description":"AWS Kinesis Firehose is a powerful service that enables almost real-time data streaming at scale. It simplifies the process of ingesting, transforming, and loading large volumes of data into various AWS services. In this guide, we’ll explore what Kinesis Firehose is, its key features, and how you can leverage it for your data processing needs.","headline":"Connecting Kinesis Firehose DataStream with aws-kinesis-agent to ingest Log Data into AWS S3","image":"https://tsypuk.github.io/images/banners/1200/pexels-anna-shvets-5965217.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsypuk.github.io/posts/2023/10/18/kineses-firehose.html"},"url":"https://tsypuk.github.io/posts/2023/10/18/kineses-firehose.html"}</script><title>Connecting Kinesis Firehose DataStream with aws-kinesis-agent to ingest Log Data into AWS S3 | Engineer's Notes</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Engineer's Notes"><meta name="application-name" content="Engineer's Notes"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LXECFRDHS1"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-LXECFRDHS1'); }); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/images/avatar/rtsypuk.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Engineer's Notes</a><p class="site-subtitle fst-italic mb-0">Cloud, Infrastructure, Architecture, Networking</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories.html" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags.html" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archived_posts.html" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/roman_tsypuk.html" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tsypuk" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/roman_tsypuk" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/roman-tsypuk" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['tsypuk_conf','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Connecting Kinesis Firehose DataStream with aws-kinesis-agent to ingest Log Data into AWS S3</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Connecting Kinesis Firehose DataStream with aws-kinesis-agent to ingest Log Data into AWS S3</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1697637600" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Oct 18, 2023 </time> </span> <span> Updated <time data-ts="1708879086" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 25, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/images/banners/1200/pexels-anna-shvets-5965217.jpeg" class="popup img-link preview-img shimmer"><img src="/images/banners/1200/pexels-anna-shvets-5965217.jpeg" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/roman-tsypuk">Roman Tsypuk</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1059 words" > <em>5 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Connecting Kinesis Firehose DataStream with aws-kinesis-agent to ingest Log Data into AWS S3</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Connecting Kinesis Firehose DataStream with aws-kinesis-agent to ingest Log Data into AWS S3</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="abstract"><span class="me-2">Abstract</span><a href="#abstract" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>AWS Kinesis Firehose is a powerful service that enables almost real-time data streaming at scale. It simplifies the process of ingesting, transforming, and loading large volumes of data into various AWS services. In this guide, we’ll explore what Kinesis Firehose is, its key features, and how you can leverage it for your data processing needs.</p><h2 id="target-infrastructure"><span class="me-2">Target Infrastructure</span><a href="#target-infrastructure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="/images/posts/kinesis/infra.png" class="popup img-link shimmer"><img src="/images/posts/kinesis/infra.png" alt="infra.png" loading="lazy"></a></p><h2 id="key-components-of-kinesis-firehose"><span class="me-2">Key Components of Kinesis Firehose</span><a href="#key-components-of-kinesis-firehose" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Delivery Streams</strong>: These are the core component of Kinesis Firehose, representing the destination where data is loaded. Each delivery stream can be configured to deliver data to one or more destinations, such as Amazon S3, Amazon Redshift, Amazon Elasticsearch, or AWS Lambda.<li><strong>Data Sources</strong>: Kinesis Firehose can ingest data from a wide range of sources including web applications, IoT devices, log files, and more. It supports both HTTP and HTTPS endpoints, making it easy to integrate with various applications.<li><strong>Transformations</strong>: Firehose allows you to transform your data before it’s delivered to the destination. This can include tasks like converting data formats, compressing data, adding prefixes to object names, and more.</ul><h2 id="integration-with-other-services"><span class="me-2">Integration with other Services</span><a href="#integration-with-other-services" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Firehose seamlessly integrates with other AWS services, allowing you to deliver data to services like Amazon S3, Redshift, Elasticsearch, and Lambda without the need for manual intervention. In this post we will set up <code class="language-plaintext highlighter-rouge">S3</code> ingegration.</p><h2 id="deploying-with-terraform"><span class="me-2">Deploying with Terraform</span><a href="#deploying-with-terraform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We are creating <code class="language-plaintext highlighter-rouge">Target Infrastructure</code> with IaC Terraform (Link to <a href="https://github.com/tsypuk/samples/tree/main/kinesis-agent">Terraform sample</a>:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="k">resource</span> <span class="s2">"aws_kinesis_firehose_delivery_stream"</span> <span class="s2">"extended_s3_stream"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="p">=</span> <span class="s2">"terraform-kinesis-firehose-logs-s3-stream"</span>
  <span class="nx">destination</span> <span class="p">=</span> <span class="s2">"extended_s3"</span>

  <span class="nx">extended_s3_configuration</span> <span class="p">{</span>
    <span class="nx">role_arn</span>           <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">firehose_role</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">bucket_arn</span>         <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">buffering_size</span>     <span class="p">=</span> <span class="mi">64</span>
    <span class="nx">buffering_interval</span> <span class="p">=</span> <span class="mi">60</span>


    <span class="nx">dynamic_partitioning_configuration</span> <span class="p">{</span>
      <span class="nx">enabled</span> <span class="p">=</span> <span class="s2">"false"</span>
    <span class="p">}</span>

    <span class="nx">prefix</span>              <span class="p">=</span> <span class="s2">"year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/hour=!{timestamp:HH}/"</span>
    <span class="nx">error_output_prefix</span> <span class="p">=</span> <span class="s2">"errors/year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/hour=!{timestamp:HH}/!{firehose:error-output-type}/"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The critical configuration to note is the buffering settings. Kinesis Firehose initiates writes to the target system when either of two conditions is met: either the buffer size in megabytes is exceeded, or the specified time interval in seconds is reached. By making these parameters configurable, you can fine-tune the near real-time behavior and the size of ingested data chunks to suit your needs.</p><p>For current use case we will prefer faster delivery instead of sizing, just for demo effect.</p><h2 id="explore-created-datafirehose"><span class="me-2">Explore Created DataFirehose</span><a href="#explore-created-datafirehose" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Once Terraform had applied with infrastructure resources created, we can explore other settings.</p><p>The general configuration of Firehose - direct PUTs into target S3 bucket:</p><p><a href="/images/posts/kinesis/firehose.png" class="popup img-link shimmer"><img src="/images/posts/kinesis/firehose.png" alt="firehose.png" loading="lazy"></a></p><p>The following settings of S3 prefixes using partitionKeyFromQuery allow to distribute the data in a virtual S3 path with time-based markers.</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nx">prefix</span>              <span class="err">=</span> <span class="s2">"year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/hour=!{timestamp:HH}/"</span>
<span class="nx">error_output_prefix</span> <span class="err">=</span> <span class="s2">"errors/year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/hour=!{timestamp:HH}/!{firehose:error-output-type}/"</span>
</pre></table></code></div></div><p>The prefix configuration in Kinesis Firehose allows you to specify a custom prefix that will be added to the objects before they are stored in the destination. This feature is particularly useful when you want to organize and categorize your data within the destination.</p><p>For example, if you’re storing data in Amazon S3, you can use a prefix like <strong>“year=2023/month=09/”</strong> to create a hierarchical structure where data is organized by year and month. This makes it easier to manage and query your data later on.</p><p>Additionally, prefixes can be dynamic and support the use of placeholders like <strong>{timestamp}</strong>, <strong>{firehose:random-string}</strong>, and others. This enables you to add dynamic elements to the prefix based on the content of the data.</p><p>Overall, prefix configuration in Kinesis Firehose provides a powerful way to structure and manage your data within the destination service, improving accessibility and organization.</p><p>How to query prefixed data we will see when running queries with Apache Spark from EMR cluster in the next post.</p><p><a href="/images/posts/kinesis/prefixes.png" class="popup img-link shimmer"><img src="/images/posts/kinesis/prefixes.png" alt="img.png" loading="lazy"></a></p><p>And of course important is to review the IAM role assigned to <code class="language-plaintext highlighter-rouge">Kinesis-Firehose</code> - the access to target S3 bucket should be allowed with write permissions.</p><p><a href="/images/posts/kinesis/policy.png" class="popup img-link shimmer"><img src="/images/posts/kinesis/policy.png" alt="policy.png" loading="lazy"></a></p><h2 id="send-data-to-the-cloud"><span class="me-2">Send Data to the Cloud</span><a href="#send-data-to-the-cloud" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now it’s time to send logs data from on-prem to AWS using <code class="language-plaintext highlighter-rouge">aws-kinesis-agent</code>, if everything is setup correctly you will see the following in logs of you agent:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>2023-10-18 13:02:08.890+0000  <span class="o">(</span>FileTailer[fh:terraform-kinesis-firehose-logs-s3-stream:/var/log/cadabra/<span class="k">*</span>.log].MetricsEmitter RUNNING<span class="o">)</span> com.amazon.kinesis.streaming.agent.tailing.FileTailer <span class="o">[</span>INFO] FileTailer[fh:terraform-kinesis-firehose-logs-s3-stream:/var/log/cadabra/<span class="k">*</span>.log]: Tailer Progress: Tailer has parsed 5000 records <span class="o">(</span>423974 bytes<span class="o">)</span>, transformed 0 records, skipped 0 records, and has successfully sent 5000 records to destination.
2023-10-18 13:02:08.903+0000  <span class="o">(</span>Agent.MetricsEmitter RUNNING<span class="o">)</span> com.amazon.kinesis.streaming.agent.Agent <span class="o">[</span>INFO] Agent: Progress: 5000 records parsed <span class="o">(</span>423974 bytes<span class="o">)</span>, and 5000 records sent successfully to destinations. Uptime: 90219ms
2023-10-18 13:02:38.890+0000  <span class="o">(</span>FileTailer[fh:terraform-kinesis-firehose-logs-s3-stream:/var/log/cadabra/<span class="k">*</span>.log].MetricsEmitter RUNNING<span class="o">)</span> com.amazon.kinesis.streaming.agent.tailing.FileTailer <span class="o">[</span>INFO] FileTailer[fh:terraform-kinesis-firehose-logs-s3-stream:/var/log/cadabra/<span class="k">*</span>.log]: Tailer Progress: Tailer has parsed 5000 records <span class="o">(</span>423974 bytes<span class="o">)</span>, transformed 0 records, skipped 0 records, and has successfully sent 5000 records to destination.
2023-10-18 13:02:38.903+0000  <span class="o">(</span>Agent.MetricsEmitter RUNNING<span class="o">)</span> com.amazon.kinesis.streaming.agent.Agent <span class="o">[</span>INFO] Agent: Progress: 5000 records parsed <span class="o">(</span>423974 bytes<span class="o">)</span>, and 5000 records sent successfully to destinations. Uptime: 120219ms
</pre></table></code></div></div><h2 id="issue-with-kinesis-agent-on-ubuntu-os"><span class="me-2">Issue with kinesis agent on Ubuntu OS</span><a href="#issue-with-kinesis-agent-on-ubuntu-os" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you have restarted Ubuntu machine (as I did 😀 ) <code class="language-plaintext highlighter-rouge">kinesis-agent</code> will fail to start again. Because, Ubuntu will drop permissions from /var/run on reboot etc. To make it work we need to update the agent configuration:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"cloudwatch.emitMetrics"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"kinesis.endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"firehose.endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firehose.eu-west-1.amazonaws.com"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"checkpointFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/opt/aws-kinesis-agent/run/checkpoints"</span><span class="w">
</span></pre></table></code></div></div><p>Add custom CheckPoint File here and also do not forget to update the permissions:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">chmod </span>ugo+rwx /opt/aws-kinesis-agent/run/chekpoints
</pre></table></code></div></div><h2 id="data-available-on-s3"><span class="me-2">Data available on S3</span><a href="#data-available-on-s3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Once buffer configuration is met (by chunk size or time) we will see in <code class="language-plaintext highlighter-rouge">S3</code>, log files ingested from on-prem:</p><p><a href="/images/posts/kinesis/s3.png" class="popup img-link shimmer"><img src="/images/posts/kinesis/s3.png" alt="img.png" loading="lazy"></a></p><p>As we have configured the logs are written to virtual folder in a time manner: <code class="language-plaintext highlighter-rouge">year/month/day/hour/</code></p><p><a href="/images/posts/kinesis/s3_prefix.png" class="popup img-link shimmer"><img src="/images/posts/kinesis/s3_prefix.png" alt="img.png" loading="lazy"></a></p><p>In this way <code class="language-plaintext highlighter-rouge">Kinesis-Firehose</code> can aggregate data in time frames, additionally perform format convertion or invoke lambda function for enrichment or data transformation (this is more advanced use cases).</p><h2 id="monitoring"><span class="me-2">Monitoring</span><a href="#monitoring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>CloudWatch provides a variety of metrics related to your Kinesis Firehose delivery stream. These metrics include data delivery rates, buffer utilization, and delivery errors. By monitoring these metrics, you can gain insights into the efficiency and reliability of your data delivery process.</p><p>On monitoring tabs we can see that records are arriving and Firehose writes to S3 without any issues.</p><p><a href="/images/posts/kinesis/monitoring.png" class="popup img-link shimmer"><img src="/images/posts/kinesis/monitoring.png" alt="monitoring.png" loading="lazy"></a></p><p>You can set up CloudWatch Alarms based on specific metrics. For example, you might set an alarm to trigger if the buffer utilization exceeds a certain threshold or if the delivery stream encounters a high rate of errors. This allows you to be proactive in addressing potential issues.</p><p>Also, Kinesis Firehose can emit log events to CloudWatch Logs. These logs provide detailed information about the activities and events related to your delivery stream. You can use these logs for troubleshooting, auditing, and performance analysis.</p><h2 id="references-links"><span class="me-2">References (Links)</span><a href="#references-links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://github.com/tsypuk/samples/tree/main/kinesis-agent">https://github.com/tsypuk/samples/tree/main/kinesis-agent</a><li><a href="https://aws.amazon.com/kinesis/data-firehose/">https://aws.amazon.com/kinesis/data-firehose/</a><li><a href="/posts/2023/10/17/kineses-agent.html">AWS Kinesis Agent configuration and setup for Data Streaming to the Cloud</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/aws/">aws</a>, <a href="/categories/kinesis/">kinesis</a>, <a href="/categories/s3/">s3</a>, <a href="/categories/firehose/">firehose</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/kinesis/" class="post-tag no-text-decoration" >kinesis</a> <a href="/tags/s3/" class="post-tag no-text-decoration" >s3</a> <a href="/tags/firehose/" class="post-tag no-text-decoration" >firehose</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Connecting%20Kinesis%20Firehose%20DataStream%20with%20aws-kinesis-agent%20to%20ingest%20Log%20Data%20into%20AWS%20S3%20-%20Engineer's%20Notes&url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F10%2F18%2Fkineses-firehose.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Connecting%20Kinesis%20Firehose%20DataStream%20with%20aws-kinesis-agent%20to%20ingest%20Log%20Data%20into%20AWS%20S3%20-%20Engineer's%20Notes&u=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F10%2F18%2Fkineses-firehose.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F10%2F18%2Fkineses-firehose.html&text=Connecting%20Kinesis%20Firehose%20DataStream%20with%20aws-kinesis-agent%20to%20ingest%20Log%20Data%20into%20AWS%20S3%20-%20Engineer's%20Notes" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F10%2F18%2Fkineses-firehose.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/2025/09/26/multiagnet-n8n-bedrock.html">Orchestrating AI multi-agent infrastructure with AWS Bedrock, OpenAI and n8n</a><li class="text-truncate lh-lg"> <a href="/posts/2025/07/20/elastic-cache-vector.html">Amazon ElastiCache Redis as a Vector Embeddings Storage for Semantic Search in AWS Community Blog posts</a><li class="text-truncate lh-lg"> <a href="/posts/2025/09/17/duckdb-s3.html">Running analytics queries from your machine with Zero-BigData stack needed on top of AWS S3(compressed JSON, Parquet, csv) or other DataSources</a><li class="text-truncate lh-lg"> <a href="/posts/2023/10/02/dynamo-design.html">DynamoDB Table Design Principles - NoSQL Modeling</a><li class="text-truncate lh-lg"> <a href="/posts/2023/10/04/dynamo-one-to-many.html">DynamoDB Table Design Principles - One-To-Many Relationships in NoSQL</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/dynamodb/">dynamodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/s3/">s3</a> <a class="post-tag btn btn-outline-primary" href="/tags/ecs/">ecs</a> <a class="post-tag btn btn-outline-primary" href="/tags/network/">network</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli/">cli</a> <a class="post-tag btn btn-outline-primary" href="/tags/fargate/">fargate</a> <a class="post-tag btn btn-outline-primary" href="/tags/firehose/">firehose</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/2023/10/19/emr-spark.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1697724000" data-df="ll" > Oct 19, 2023 </time><h4 class="pt-0 my-2">Running Recommendation Engine Spark Job on EMR</h4><div class="text-muted"><p>Abstract Amazon Elastic MapReduce (EMR) is a managed big data service that simplifies the process of processing and analyzing large datasets using popular frameworks like Apache Spark, Hadoop, and ...</p></div></div></a></article><article class="col"> <a href="/posts/2023/10/17/kineses-agent.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1697551200" data-df="ll" > Oct 17, 2023 </time><h4 class="pt-0 my-2">AWS Kinesis Agent configuration and setup for Data Streaming to the Cloud</h4><div class="text-muted"><p>Abstract Amazon Kinesis Agent is a powerful tool that helps you collect, process, and transfer data in real-time to AWS services like Amazon Kinesis Data Streams, Amazon Kinesis Data Firehose, and...</p></div></div></a></article><article class="col"> <a href="/posts/2024/02/03/s3-signed-urls.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1706968800" data-df="ll" > Feb 3, 2024 </time><h4 class="pt-0 my-2">AWS S3-presigned URLs: Deep Dive and Use Cases of secure file transfers</h4><div class="text-muted"><p>Abstract One of AWS S3 features is very useful, but not so many developers and architects are familiar with it - the capability to generate presigned URLs. In this blog post, we will explore wha...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/2023/10/17/kineses-agent.html" class="btn btn-outline-primary" aria-label="Older" ><p>AWS Kinesis Agent configuration and setup for Data Streaming to the Cloud</p></a> <a href="/posts/2023/10/19/emr-spark.html" class="btn btn-outline-primary" aria-label="Newer" ><p>Running Recommendation Engine Spark Job on EMR</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://www.linkedin.com/in/roman-tsypuk">Roman Tsypuk</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span> <span data-bs-toggle="tooltip" data-bs-placement="top" title="2025-09-26 20:11:52 +0300 &#013;be60bb44e6416aa69b8fd68791db025be40c523c">Build version: be60bb4</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/dynamodb/">dynamodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/s3/">s3</a> <a class="post-tag btn btn-outline-primary" href="/tags/ecs/">ecs</a> <a class="post-tag btn btn-outline-primary" href="/tags/network/">network</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli/">cli</a> <a class="post-tag btn btn-outline-primary" href="/tags/fargate/">fargate</a> <a class="post-tag btn btn-outline-primary" href="/tags/firehose/">firehose</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'tsypuk/tsypuk.github.io', 'data-repo-id': 'R_kgDOIxaFiw', 'data-category': 'General', 'data-category-id': 'DIC_kwDOIxaFi84CUSfn', 'data-mapping': 'og:title', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'top', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
