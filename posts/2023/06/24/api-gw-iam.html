<!doctype html><html lang="en" ><head> <script async src="https://www.googletagmanager.com/gtag/js?id=G-LXECFRDHS1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-LXECFRDHS1'); </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="AWS API Gateway with AWS IAM authorization | by Roman Tsypuk" /><meta name="author" content="Roman Tsypuk" /><meta property="og:locale" content="en" /><meta name="description" content="AWS API Gateway is widely used in various integrations and architectures. One common use case for enhancing its authorization level is by incorporating an authorizer lambda or integrating it with AWS Cognito. However, there is another interesting option that allows to control access to API method level using AWS IAM auth type. In this post we will create and deploy infra with terraform, secure endpoint with AWS IAM and will also take a look on sigv4 client algorithm." /><meta property="og:description" content="AWS API Gateway is widely used in various integrations and architectures. One common use case for enhancing its authorization level is by incorporating an authorizer lambda or integrating it with AWS Cognito. However, there is another interesting option that allows to control access to API method level using AWS IAM auth type. In this post we will create and deploy infra with terraform, secure endpoint with AWS IAM and will also take a look on sigv4 client algorithm." /><meta property="twitter:description" content="AWS API Gateway is widely used in various integrations and architectures. One common use case for enhancing its authorization level is by incorporating an authorizer lambda or integrating it with AWS Cognito. However, there is another interesting option that allows to control access to API method level using AWS IAM auth type. In this post we will create and deploy infra with terraform, secure endpoint with AWS IAM and will also take a look on sigv4 client algorithm." /><link rel="canonical" href="https://tsypuk.github.io/posts/2023/06/24/api-gw-iam.html" /><meta property="og:url" content="https://tsypuk.github.io/posts/2023/06/24/api-gw-iam.html" /><meta property="og:site_name" content="Engineer’s Notes | Roman Tsypuk" /><meta property="og:image" content="https://tsypuk.github.io/images/banners/1200/pexels-pew-nguyen-241028.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-06-24T17:00:00+03:00" /><meta name="publish_date" property="og:publish_date" content="2023-06-24T17:00:00+03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://tsypuk.github.io/images/banners/1200/pexels-pew-nguyen-241028.jpeg" /><meta property="twitter:title" content="AWS API Gateway with AWS IAM authorization | by Roman Tsypuk" /><meta name="twitter:site" content="@roman_tsypuk" /><meta name="twitter:creator" content="@roman_tsypuk" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Roman Tsypuk"},"dateModified":"2024-02-25T18:38:06+02:00","datePublished":"2023-06-24T17:00:00+03:00","description":"AWS API Gateway is widely used in various integrations and architectures. One common use case for enhancing its authorization level is by incorporating an authorizer lambda or integrating it with AWS Cognito. However, there is another interesting option that allows to control access to API method level using AWS IAM auth type. In this post we will create and deploy infra with terraform, secure endpoint with AWS IAM and will also take a look on sigv4 client algorithm.","headline":"AWS API Gateway with AWS IAM authorization","image":"https://tsypuk.github.io/images/banners/1200/pexels-pew-nguyen-241028.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsypuk.github.io/posts/2023/06/24/api-gw-iam.html"},"url":"https://tsypuk.github.io/posts/2023/06/24/api-gw-iam.html"}</script><title>AWS API Gateway with AWS IAM authorization | Engineer's Notes</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Engineer's Notes"><meta name="application-name" content="Engineer's Notes"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LXECFRDHS1"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-LXECFRDHS1'); }); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/images/avatar/rtsypuk.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Engineer's Notes</a><p class="site-subtitle fst-italic mb-0">Cloud, Infrastructure, Architecture, Networking</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories.html" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags.html" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archived_posts.html" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/roman_tsypuk.html" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tsypuk" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/roman_tsypuk" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/roman-tsypuk" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['tsypuk_conf','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>AWS API Gateway with AWS IAM authorization</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>AWS API Gateway with AWS IAM authorization</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1687615200" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jun 24, 2023 </time> </span> <span> Updated <time data-ts="1708879086" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 25, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/images/banners/1200/pexels-pew-nguyen-241028.jpeg" class="popup img-link preview-img shimmer"><img src="/images/banners/1200/pexels-pew-nguyen-241028.jpeg" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/roman-tsypuk">Roman Tsypuk</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="941 words" > <em>5 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">AWS API Gateway with AWS IAM authorization</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">AWS API Gateway with AWS IAM authorization</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="abstract"><span class="me-2">Abstract</span><a href="#abstract" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>AWS API Gateway is widely used in various integrations and architectures. One common use case for enhancing its authorization level is by incorporating an authorizer lambda or integrating it with AWS Cognito.</p><p>However, there is another interesting option that allows to control access to API method level using AWS IAM auth type. In this post we will create and deploy infra with terraform, secure endpoint with AWS IAM and will also take a look on sigv4 client algorithm.</p><h2 id="target-architecture-for-this-post"><span class="me-2">Target Architecture for this post:</span><a href="#target-architecture-for-this-post" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="/images/posts/aws-apigw-iam/api-gw-iam.png" class="popup img-link shimmer"><img src="/images/posts/aws-apigw-iam/api-gw-iam.png" alt="api-gw-iam.png" loading="lazy"></a></p><p>We are creating API Gateway with resource <code class="language-plaintext highlighter-rouge">../path1</code> that has method <code class="language-plaintext highlighter-rouge">GET</code>: for proxying all requests to public https endpoint. For this post we will use amazon public endpoint with ip ranges - https://ip-ranges.amazonaws.com/ip-ranges.json</p><p>This endpoint will be secured with type AWS_IAM. So only instances that have attached role or CLI programmatic users with proper permissions can access this endpoint.</p><h2 id="code-snippets-are-available-on-github"><span class="me-2">Code snippets are available on github:</span><a href="#code-snippets-are-available-on-github" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://github.com/tsypuk/samples/tree/main/apigw">https://github.com/tsypuk/samples/tree/main/apigw</a></ul><h2 id="creating-infrastructure-with-terraform"><span class="me-2">Creating infrastructure with Terraform</span><a href="#creating-infrastructure-with-terraform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>API endpoint provisioning with terraform using openapi spec:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="k">resource</span> <span class="s2">"aws_api_gateway_rest_api"</span> <span class="s2">"sigv4_rest_api"</span> <span class="p">{</span>
  <span class="nx">body</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">openapi</span> <span class="p">=</span> <span class="s2">"3.0.1"</span>
    <span class="nx">info</span>    <span class="p">=</span> <span class="p">{</span>
      <span class="nx">title</span>   <span class="p">=</span> <span class="s2">"SigV4 verification"</span>
      <span class="nx">version</span> <span class="p">=</span> <span class="s2">"1.0"</span>
    <span class="p">}</span>
    <span class="nx">paths</span> <span class="p">=</span> <span class="p">{</span>
      <span class="s2">"/path1"</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">get</span> <span class="p">=</span> <span class="p">{</span>
          <span class="nx">security</span> <span class="err">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">sigv4</span> <span class="err">:</span> <span class="p">[]</span>
            <span class="p">}</span>
          <span class="p">]</span>
          <span class="nx">x-amazon-apigateway-integration</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">httpMethod</span>           <span class="p">=</span> <span class="s2">"GET"</span>
            <span class="nx">payloadFormatVersion</span> <span class="p">=</span> <span class="s2">"1.0"</span>
            <span class="nx">type</span>                 <span class="p">=</span> <span class="s2">"HTTP_PROXY"</span>
            <span class="nx">uri</span>                  <span class="p">=</span> <span class="s2">"https://ip-ranges.amazonaws.com/ip-ranges.json"</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="p">)</span>


  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"API Gateway"</span>
  <span class="nx">name</span>        <span class="p">=</span> <span class="s2">"Regional API GW with 'AWS IAM' auth type"</span>

  <span class="nx">endpoint_configuration</span> <span class="p">{</span>
    <span class="nx">types</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"REGIONAL"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now, let’s proceed to define AWS IAM authorization at the API Gateway level, alongside the path declaration. In the context of API Gateway, this authorization type is known as “awsSigv4”.</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nx">components</span> <span class="err">=</span> <span class="p">{</span>
      <span class="nx">securitySchemes</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">sigv4</span> <span class="p">=</span> <span class="p">{</span>
          <span class="nx">type</span>                         <span class="p">=</span> <span class="s2">"apiKey"</span>
          <span class="nx">name</span>                         <span class="p">=</span> <span class="s2">"Authorization"</span>
          <span class="nx">in</span> <span class="err">:</span> <span class="s2">"header"</span>
          <span class="nx">x-amazon-apigateway-authtype</span> <span class="p">=</span> <span class="s2">"awsSigv4"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>At this moment we have created API GW, single <code class="language-plaintext highlighter-rouge">path1</code> resource with <code class="language-plaintext highlighter-rouge">GET</code> method that proxies all incoming requests.</p><p><a href="/images/posts/aws-apigw-iam/aws-console-apigw.png" class="popup img-link shimmer"><img src="/images/posts/aws-apigw-iam/aws-console-apigw.png" alt="aws-console-apigw.png" loading="lazy"></a></p><h2 id="now-lets-define-deployment"><span class="me-2">Now lets define Deployment</span><a href="#now-lets-define-deployment" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1"># Deployment</span>
<span class="k">resource</span> <span class="s2">"aws_api_gateway_deployment"</span> <span class="s2">"prod-deployment"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="p">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">sigv4_rest_api</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">triggers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">redeployment</span> <span class="p">=</span> <span class="nx">sha1</span><span class="p">(</span><span class="nx">jsonencode</span><span class="p">(</span><span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">sigv4_rest_api</span><span class="p">.</span><span class="nx">body</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">create_before_destroy</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_api_gateway_stage"</span> <span class="s2">"PROD"</span> <span class="p">{</span>
  <span class="nx">deployment_id</span>        <span class="p">=</span> <span class="nx">aws_api_gateway_deployment</span><span class="p">.</span><span class="nx">prod-deployment</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">rest_api_id</span>          <span class="p">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">sigv4_rest_api</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">stage_name</span>           <span class="p">=</span> <span class="s2">"PROD"</span>
  <span class="nx">xray_tracing_enabled</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></table></code></div></div><p>API gateway is deployed into stage <code class="language-plaintext highlighter-rouge">PROD</code> it has autogenerated URL and is available for accessing:</p><p><a href="/images/posts/aws-apigw-iam/aws-console-deployment.png" class="popup img-link shimmer"><img src="/images/posts/aws-apigw-iam/aws-console-deployment.png" alt="img.png" loading="lazy"></a></p><h2 id="calling-api-gw-without-credentials"><span class="me-2">Calling API GW without credentials:</span><a href="#calling-api-gw-without-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="/images/posts/aws-apigw-iam/postman-no-auth.png" class="popup img-link shimmer"><img src="/images/posts/aws-apigw-iam/postman-no-auth.png" alt="img.png" loading="lazy"></a></p><p>As we have secured our resource and its HTTP method with the AWS IAM authentication type, when making a regular HTTP call, we will receive a <code class="language-plaintext highlighter-rouge">403 Forbidden</code> status code along with an error message.</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Missing Authentication Token"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="to-authorize-on-api-gw-we-need-iam-programmatic-user-with-proper-permissions-lets-create-it-with-terraform"><span class="me-2">To authorize on API GW we need IAM programmatic user with proper permissions, let’s create it with Terraform:</span><a href="#to-authorize-on-api-gw-we-need-iam-programmatic-user-with-proper-permissions-lets-create-it-with-terraform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Take a look at <code class="language-plaintext highlighter-rouge">Resource = "arn:aws:execute-api:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:${aws_api_gateway_rest_api.sigv4_rest_api.id}/${aws_api_gateway_stage.PROD.stage_name}/GET/path1"</code> declaration it is dynamically generated with proper params from previously created resources.</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1"># Programmatic IAM user</span>
<span class="k">resource</span> <span class="s2">"aws_iam_user"</span> <span class="s2">"user"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="s2">"api-caller"</span>
  <span class="nx">path</span> <span class="p">=</span> <span class="s2">"/"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_iam_user_policy"</span> <span class="s2">"apigw_invoke_policy_inline"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="s2">"allow-invoke-get-method-policy"</span>
  <span class="nx">user</span> <span class="p">=</span> <span class="nx">aws_iam_user</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span>

  <span class="nx">policy</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span>   <span class="p">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="p">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Action</span> <span class="p">=</span> <span class="p">[</span>
          <span class="s2">"execute-api:Invoke"</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="nx">Effect</span>   <span class="p">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Resource</span> <span class="p">=</span> <span class="s2">"arn:aws:execute-api:</span><span class="k">${data</span><span class="p">.</span><span class="nx">aws_region</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">name</span><span class="k">}</span><span class="s2">:</span><span class="k">${data</span><span class="p">.</span><span class="nx">aws_caller_identity</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">account_id</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">sigv4_rest_api</span><span class="p">.</span><span class="nx">id</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">PROD</span><span class="p">.</span><span class="nx">stage_name</span><span class="k">}</span><span class="s2">/GET/path1"</span>
      <span class="p">},</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As a result we will create <code class="language-plaintext highlighter-rouge">IAM user</code> <code class="language-plaintext highlighter-rouge">api-caller</code> with following <code class="language-plaintext highlighter-rouge">allow-invoke-get-method-policy</code> policy:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"execute-api:Invoke"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:execute-api:eu-central-1:123456789:irjzyov5a7/PROD/GET/path1"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="aws-permission-declaration-for-execute-apiinvoke-aws-iam-auth"><span class="me-2">AWS permission declaration for execute-api:Invoke AWS IAM auth</span><a href="#aws-permission-declaration-for-execute-apiinvoke-aws-iam-auth" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This permission once attached to user or role, allows the owner to access our http endpoint.</p><p>The full qualifier path of resource in the permission is defined as following expression: <code class="language-plaintext highlighter-rouge">arn:aws:execute-api:region:account-id:api-id/stage-name/HTTP-VERB/resource-path-specifier</code></p><p><code class="language-plaintext highlighter-rouge">*</code> wildcard can be used in any part of this expression to make it more wide. But according to <code class="language-plaintext highlighter-rouge">least privileged principle</code> try to keep it as narrow as possible (fully defining all parameters with values).</p><p>According to our deployment it will have the following values:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">key<th style="text-align: left">value<tbody><tr><td style="text-align: left">region<td style="text-align: left">eu-central-1<tr><td style="text-align: left">account-id<td style="text-align: left">123456789<tr><td style="text-align: left">api-id<td style="text-align: left">irjzyov5a7<tr><td style="text-align: left">stage-name<td style="text-align: left">PROD<tr><td style="text-align: left">HTTP-VERB<td style="text-align: left">GET<tr><td style="text-align: left">resource-path-specifier<td style="text-align: left">path</table></div><p>After user is provisioned we can access aws web console and generate ACCESS and SECRET key (that we will use when calling API).</p><h2 id="calling-api-gw-with-iam"><span class="me-2">Calling API GW with IAM</span><a href="#calling-api-gw-with-iam" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>So when calling same API from postman, you should select <code class="language-plaintext highlighter-rouge">AWS Signature</code> in Authorization type, define <code class="language-plaintext highlighter-rouge">AccessKey</code> <code class="language-plaintext highlighter-rouge">SecretKey</code> <code class="language-plaintext highlighter-rouge">AWS Region</code> <code class="language-plaintext highlighter-rouge">Service Name</code>, the request is successful:</p><p><a href="/images/posts/aws-apigw-iam/postman-aws-signature.png" class="popup img-link shimmer"><img src="/images/posts/aws-apigw-iam/postman-aws-signature.png" alt="img.png" loading="lazy"></a></p><h2 id="aws-access-and-secret-keys-are-not-transfered-over-network-sig-v4-algorithm-is-used-instead-to-generate-the-signature-and-sign-all-http-calls-to-aws-endpoints"><span class="me-2">AWS Access and Secret keys are not transfered over network, sig-v4 algorithm is used instead to generate the signature and sign all HTTP calls to AWS endpoints</span><a href="#aws-access-and-secret-keys-are-not-transfered-over-network-sig-v4-algorithm-is-used-instead-to-generate-the-signature-and-sign-all-http-calls-to-aws-endpoints" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote class="prompt-tip"><p>To prevent tampering with a request while it’s in transit, some request elements are used to calculate a hash (digest) of the request, and the resulting hash value is included as part of the request. When an AWS service receives the request, it uses the same information to calculate a hash and matches it against the hash value in your request. If the values don’t match, AWS denies the request.</p></blockquote><blockquote class="prompt-tip"><p>In most cases, a request must reach AWS within five minutes of the time stamp in the request. Otherwise, AWS denies the request.</p></blockquote><p>In next post we will explore this algorithm in details using <code class="language-plaintext highlighter-rouge">mitmproxy</code> interceptor and will assemble the sign hash.</p><h2 id="references-links"><span class="me-2">References (Links):</span><a href="#references-links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html">https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html</a><li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_aws-signing.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_aws-signing.html</a><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_rest_api">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_rest_api</a><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-access-control-iam.html">https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-access-control-iam.html</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/aws/">aws</a>, <a href="/categories/iam/">iam</a>, <a href="/categories/security/">security</a>, <a href="/categories/sigv4/">sigv4</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/iam/" class="post-tag no-text-decoration" >iam</a> <a href="/tags/security/" class="post-tag no-text-decoration" >security</a> <a href="/tags/sigv4/" class="post-tag no-text-decoration" >sigv4</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AWS%20API%20Gateway%20with%20AWS%20IAM%20authorization%20-%20Engineer's%20Notes&url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F06%2F24%2Fapi-gw-iam.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AWS%20API%20Gateway%20with%20AWS%20IAM%20authorization%20-%20Engineer's%20Notes&u=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F06%2F24%2Fapi-gw-iam.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F06%2F24%2Fapi-gw-iam.html&text=AWS%20API%20Gateway%20with%20AWS%20IAM%20authorization%20-%20Engineer's%20Notes" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2023%2F06%2F24%2Fapi-gw-iam.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/2025/09/26/multiagnet-n8n-bedrock.html">Orchestrating AI multi-agent infrastructure with AWS Bedrock, OpenAI and n8n</a><li class="text-truncate lh-lg"> <a href="/posts/2025/07/20/elastic-cache-vector.html">Amazon ElastiCache Redis as a Vector Embeddings Storage for Semantic Search in AWS Community Blog posts</a><li class="text-truncate lh-lg"> <a href="/posts/2025/09/17/duckdb-s3.html">Running analytics queries from your machine with Zero-BigData stack needed on top of AWS S3(compressed JSON, Parquet, csv) or other DataSources</a><li class="text-truncate lh-lg"> <a href="/posts/2023/10/02/dynamo-design.html">DynamoDB Table Design Principles - NoSQL Modeling</a><li class="text-truncate lh-lg"> <a href="/posts/2023/10/04/dynamo-one-to-many.html">DynamoDB Table Design Principles - One-To-Many Relationships in NoSQL</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/dynamodb/">dynamodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/s3/">s3</a> <a class="post-tag btn btn-outline-primary" href="/tags/ecs/">ecs</a> <a class="post-tag btn btn-outline-primary" href="/tags/network/">network</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli/">cli</a> <a class="post-tag btn btn-outline-primary" href="/tags/fargate/">fargate</a> <a class="post-tag btn btn-outline-primary" href="/tags/firehose/">firehose</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/2023/07/16/mitmproxy-hmac.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1689516000" data-df="ll" > Jul 16, 2023 </time><h4 class="pt-0 my-2">Intercepting AWS CLI and SDK API calls with MITM proxy. How ACCESS_KEY and ACCESS_SECRET_KEY are applied. Signature Version 4 Under the Hood.</h4><div class="text-muted"><p>Abstract In the previous post we have checked how to setup AWS API Gateway with AWS IAM authorization. To access its secured endpoint we were using Postman, all we need to call the API is to choose...</p></div></div></a></article><article class="col"> <a href="/posts/2024/02/11/system-manager.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1707660000" data-df="ll" > Feb 11, 2024 </time><h4 class="pt-0 my-2">AWS SSM Session Manager as secure Hub to establish multiple Connections to instances and Port Forwarding</h4><div class="text-muted"><p>Abstract Port forwarding or SSH tunnelling is technic widely used to map remote ports to a client machine with possibility of remapping. The data traffic is encrypted and transferred within SSH tu...</p></div></div></a></article><article class="col"> <a href="/posts/2023/02/08/aws-vpc-traffic-mirroring-ids-suricata.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1675850400" data-df="ll" > Feb 8, 2023 </time><h4 class="pt-0 my-2">AWS VPC traffic mirroring to IDS. Deep dive with Wireshark.</h4><div class="text-muted"><p>Abstract Traffic mirroring refers to the process of copying network traffic from one network port or interface to another for analysis, monitoring, or security purposes. There are multiple options...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/2023/04/02/costs.html" class="btn btn-outline-primary" aria-label="Older" ><p>AWS Costs optimization Tools and Frameworks: Extract from AWS Series</p></a> <a href="/posts/2023/07/16/mitmproxy-hmac.html" class="btn btn-outline-primary" aria-label="Newer" ><p>Intercepting AWS CLI and SDK API calls with MITM proxy. How ACCESS_KEY and ACCESS_SECRET_KEY are applied. Signature Version 4 Under the Hood.</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://www.linkedin.com/in/roman-tsypuk">Roman Tsypuk</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span> <span data-bs-toggle="tooltip" data-bs-placement="top" title="2025-09-26 20:11:52 +0300 &#013;be60bb44e6416aa69b8fd68791db025be40c523c">Build version: be60bb4</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/dynamodb/">dynamodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/s3/">s3</a> <a class="post-tag btn btn-outline-primary" href="/tags/ecs/">ecs</a> <a class="post-tag btn btn-outline-primary" href="/tags/network/">network</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli/">cli</a> <a class="post-tag btn btn-outline-primary" href="/tags/fargate/">fargate</a> <a class="post-tag btn btn-outline-primary" href="/tags/firehose/">firehose</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'tsypuk/tsypuk.github.io', 'data-repo-id': 'R_kgDOIxaFiw', 'data-category': 'General', 'data-category-id': 'DIC_kwDOIxaFi84CUSfn', 'data-mapping': 'og:title', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'top', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
