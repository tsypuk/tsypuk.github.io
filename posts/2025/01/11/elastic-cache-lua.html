<!doctype html><html lang="en" ><head> <script async src="https://www.googletagmanager.com/gtag/js?id=G-LXECFRDHS1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-LXECFRDHS1'); </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Making Extremely Fast AWS Elastic Cache Redis with Lua | by Roman Tsypuk" /><meta name="author" content="Roman Tsypuk" /><meta property="og:locale" content="en" /><meta name="description" content="AWS ElastiCache for Redis offers a managed, high-performance, in-memory data store that is widely adopted for caching, session management, real-time analytics, and more. To further enhance performance, Redis includes support for Lua scripting, enabling developers to execute complex operations atomically and reduce the overhead of multiple network calls." /><meta property="og:description" content="AWS ElastiCache for Redis offers a managed, high-performance, in-memory data store that is widely adopted for caching, session management, real-time analytics, and more. To further enhance performance, Redis includes support for Lua scripting, enabling developers to execute complex operations atomically and reduce the overhead of multiple network calls." /><meta property="twitter:description" content="AWS ElastiCache for Redis offers a managed, high-performance, in-memory data store that is widely adopted for caching, session management, real-time analytics, and more. To further enhance performance, Redis includes support for Lua scripting, enabling developers to execute complex operations atomically and reduce the overhead of multiple network calls." /><link rel="canonical" href="https://tsypuk.github.io/posts/2025/01/11/elastic-cache-lua.html" /><meta property="og:url" content="https://tsypuk.github.io/posts/2025/01/11/elastic-cache-lua.html" /><meta property="og:site_name" content="Engineerâ€™s Notes | Roman Tsypuk" /><meta property="og:image" content="https://tsypuk.github.io/images/banners/1200/pexels-punlob-173477-564096.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-01-11T00:00:00+02:00" /><meta name="publish_date" property="og:publish_date" content="2025-01-11T00:00:00+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://tsypuk.github.io/images/banners/1200/pexels-punlob-173477-564096.jpg" /><meta property="twitter:title" content="Making Extremely Fast AWS Elastic Cache Redis with Lua | by Roman Tsypuk" /><meta name="twitter:site" content="@roman_tsypuk" /><meta name="twitter:creator" content="@roman_tsypuk" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Roman Tsypuk"},"dateModified":"2025-01-11T00:00:00+02:00","datePublished":"2025-01-11T00:00:00+02:00","description":"AWS ElastiCache for Redis offers a managed, high-performance, in-memory data store that is widely adopted for caching, session management, real-time analytics, and more. To further enhance performance, Redis includes support for Lua scripting, enabling developers to execute complex operations atomically and reduce the overhead of multiple network calls.","headline":"Making Extremely Fast AWS Elastic Cache Redis with Lua","image":"https://tsypuk.github.io/images/banners/1200/pexels-punlob-173477-564096.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsypuk.github.io/posts/2025/01/11/elastic-cache-lua.html"},"url":"https://tsypuk.github.io/posts/2025/01/11/elastic-cache-lua.html"}</script><title>Making Extremely Fast AWS Elastic Cache Redis with Lua | Engineer's Notes</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Engineer's Notes"><meta name="application-name" content="Engineer's Notes"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LXECFRDHS1"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-LXECFRDHS1'); }); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/images/avatar/rtsypuk.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Engineer's Notes</a><p class="site-subtitle fst-italic mb-0">Cloud, Infrastructure, Architecture, Networking</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories.html" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags.html" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archived_posts.html" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/roman_tsypuk.html" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tsypuk" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/roman_tsypuk" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/roman-tsypuk" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['tsypuk_conf','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Making Extremely Fast AWS Elastic Cache Redis with Lua</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Making Extremely Fast AWS Elastic Cache Redis with Lua</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1736546400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 11, 2025 </time> </span><div class="mt-3 mb-3"> <a href="/images/banners/1200/pexels-punlob-173477-564096.jpg" class="popup img-link preview-img shimmer"><img src="/images/banners/1200/pexels-punlob-173477-564096.jpg" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/roman-tsypuk">Roman Tsypuk</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1328 words" > <em>7 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Making Extremely Fast AWS Elastic Cache Redis with Lua</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Making Extremely Fast AWS Elastic Cache Redis with Lua</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>AWS ElastiCache for Redis offers a managed, high-performance, in-memory data store that is widely adopted for caching, session management, real-time analytics, and more. To further enhance performance, Redis includes support for Lua scripting, enabling developers to execute complex operations atomically and reduce the overhead of multiple network calls.</p><p>This combination of AWS ElastiCache for Redis and Lua scripting provides a powerful framework for optimizing workloads. By leveraging Lua, developers can move compute logic closer to the data, minimizing latency and improving throughput for critical operations. In this guide, weâ€™ll explore how to use Lua scripting in AWS ElastiCache for Redis</p><h2 id="elastic-cache-and-redis-versions"><span class="me-2">Elastic Cache and Redis versions</span><a href="#elastic-cache-and-redis-versions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Amazon ElastiCache is a fully managed, in-memory data store and cache service that supports both Redis OSS (Open Source Software) and Valkey-compatible engines. As of January 2025, ElastiCache offers support for the following Redis OSS versions:</p><ul><li>Redis OSS 7.1: This version includes performance enhancements, such as extended enhanced I/O threads and improved memory access patterns, enabling workloads to achieve higher throughput and lower latencies.<li>Redis OSS 5.0.6: Includes features like Streams, improved memory efficiency, and better eviction policies.<li>Redis OSS 4.0.10: Provides enhancements in memory management and introduces modules for extending Redis functionalities.</ul><p>Itâ€™s important to note that earlier versions, such as Redis OSS 3.x and 2.x, have reached End of Life (EOL) and are no longer supported.</p><p>Additionally, AWS has introduced Valkey, a Redis-compatible engine that offers enhanced performance and features. Valkey is designed to be compatible with Redis APIs, ensuring that your existing applications can work seamlessly with it.</p><p>So prior adding <strong>Lua</strong> check you redis version and lua interpreter version:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>redis-cli <span class="nt">-h</span> domain.cache.amazonaws.com <span class="nt">-p</span> 6379
domain.cache.amazonaws.com:6379&gt; info
<span class="c"># Server</span>
redis_version:5.0.6
redis_git_sha1:0
redis_git_dirty:0
redis_build_id:0
redis_mode:cluster
os:Amazon ElastiCache
arch_bits:64
</pre></table></code></div></div><h2 id="elastic-common-use-cases"><span class="me-2">Elastic common use cases</span><a href="#elastic-common-use-cases" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Redis (Remote Dictionary Server) is a highly versatile, in-memory data store often used for its performance, simplicity, and flexibility. Below are common use cases where Redis excels:</p><ul><li>Caching (TTL)<li>Session Management<li>Real-Time Analytics<li>Pub/Sub Messaging<li>Leaderboards and Ranking Systems<li>Distributed Locks<li>Queue Management<li>Configuration and Feature Flags<li>Gaming and Real-Time Applications</ul><h2 id="where-lua-is-used"><span class="me-2">Where Lua is used?</span><a href="#where-lua-is-used" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Lua is a lightweight, high-performance scripting language widely used in various fields due to its simplicity, extensibility, and ease of embedding in applications.</p><p>Here are some prominent examples of where Lua is used:</p><ul><li>Game engines (Unity, World of Warcraft, Angry Birds, MineCraft)<li>Embedded Systems (Cisco devices automation and scripting, smart-TV, IP-boxes, IoT)<li>Web (Kong API Gateway, Nginx scripting)<li>DB (Redis, Tarantool)<li>Networking (Wireshark plugins, Snort IDS)<li>Video (VLC plugins)</ul><p>Lua has a small footprint (less than 30K lines of code of core, GC and virtual Machine code) with high performance make it ideal for resource-constrained environments.</p><h2 id="how-redis-executed-lua"><span class="me-2">How Redis executed Lua</span><a href="#how-redis-executed-lua" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Redis executes Lua scripts using its built-in Lua interpreter, which is based on the Lua 5.1 engine. This mechanism allows atomic execution of scripts and provides several benefits for transactional or complex operations in Redis.</p><p>Hereâ€™s how Redis executes Lua scripts step by step:</p><ul><li>A Lua script is sent to Redis using the EVAL or EVALSHA command.<li>Redis passes the Lua script to its built-in Lua interpreter.<li>The entire Lua script is executed as a single atomic operation. No other commands can run during the script execution. This guarantees consistency, similar to a transaction.</ul><h2 id="data-locality"><span class="me-2">Data Locality</span><a href="#data-locality" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Besides transactional guarantee, Redis executes all Lua script code on a interpreter at data node.</p><p>As a results there is no overhead for sending multiple requests for each command of script and have any network overhead.</p><p>Such scripts are executed fast and have direct access to Data.</p><h2 id="mutation-scripts"><span class="me-2">Mutation Scripts</span><a href="#mutation-scripts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As a best practice only mutation operations (scripts) are placed under Lua script which guarantees the transactional execution. The read calls are follow eventual consistancy and do not require Lua scripting.</p><p>Here are examples of Lua scripts that perform complex logic of both TTL and SET for unique user records modification sessions:</p><h3 id="locking"><span class="me-2">Locking</span><a href="#locking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-lua highlighter-rouge"><div class="code-header"> <span data-label-text="Lua"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">-- Lua script for managing a set with TTL for values</span>
<span class="c1">-- Parameters:</span>
<span class="c1">-- KEYS[1] - the key representing the id</span>
<span class="c1">-- ARGV[1] - the conv_message_id to add to the set</span>
<span class="c1">-- Get the current timestamp from Redis server in seconds</span>
<span class="kd">local</span> <span class="n">currentTimestamp</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'TIME'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">-- Define the TTL (300 seconds)</span>
<span class="kd">local</span> <span class="n">ttl</span> <span class="o">=</span> <span class="mi">300</span>

<span class="c1">-- Calculate the expiration timestamp for the given conv_message_id</span>
<span class="kd">local</span> <span class="n">expirationTimestamp</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">currentTimestamp</span><span class="p">)</span> <span class="o">+</span> <span class="n">ttl</span>

<span class="c1">-- Add the conv_message_id to the sorted set with its expiration timestamp as the score</span>
<span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZADD'</span><span class="p">,</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">expirationTimestamp</span><span class="p">,</span> <span class="n">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1">-- Remove all values from the set where the TTL (score) is less than the current timestamp</span>
<span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZREMRANGEBYSCORE'</span><span class="p">,</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'-inf'</span><span class="p">,</span> <span class="n">currentTimestamp</span><span class="p">)</span>

<span class="c1">-- Retrieve all elements from the set after cleanup</span>
<span class="kd">local</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZRANGE'</span><span class="p">,</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">-- Return all elements</span>
<span class="k">return</span> <span class="n">elements</span>
</pre></table></code></div></div><h3 id="lock-release"><span class="me-2">Lock release:</span><a href="#lock-release" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-lua highlighter-rouge"><div class="code-header"> <span data-label-text="Lua"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="kd">local</span> <span class="n">userID</span> <span class="o">=</span> <span class="n">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">-- Get the current timestamp from Redis server in seconds</span>
<span class="kd">local</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'TIME'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">-- Remove all values from the set where the TTL (score) is less than the current timestamp</span>
<span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZREMRANGEBYSCORE'</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="s1">'-inf'</span><span class="p">,</span> <span class="n">currentTime</span><span class="p">)</span>

<span class="c1">-- Retrieve all remaining valid entries from the set</span>
<span class="kd">local</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZRANGE'</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">-- Prepare the arguments for a single ZREM call</span>
<span class="kd">local</span> <span class="n">zremArgs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">entry</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">entry</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">"^"</span> <span class="o">..</span> <span class="n">userID</span> <span class="o">..</span> <span class="s2">":(.-):preordered$"</span><span class="p">)</span> <span class="k">then</span>
        <span class="nb">table.insert</span><span class="p">(</span><span class="n">zremArgs</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="c1">-- Remove all preordered entries in a single ZREM call</span>
<span class="k">if</span> <span class="o">#</span><span class="n">zremArgs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span>
    <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZREM'</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">unpack</span><span class="p">(</span><span class="n">zremArgs</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">return</span> <span class="kc">true</span>
</pre></table></code></div></div><h3 id="changing-the-state-of-record"><span class="me-2">Changing the state of Record:</span><a href="#changing-the-state-of-record" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-lua highlighter-rouge"><div class="code-header"> <span data-label-text="Lua"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kd">local</span> <span class="n">id</span> <span class="o">=</span>  <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>           <span class="c1">-- The key for the ZSET</span>
<span class="kd">local</span> <span class="n">userID</span> <span class="o">=</span> <span class="n">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>          <span class="c1">-- The user ID</span>
<span class="kd">local</span> <span class="n">product</span> <span class="o">=</span> <span class="n">ARGV</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>          <span class="c1">-- The conversation ID</span>
<span class="kd">local</span> <span class="n">ttlOffset</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">ARGV</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">-- TTL offset in seconds</span>

<span class="c1">-- Get the current timestamp from Redis</span>
<span class="kd">local</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'TIME'</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
<span class="kd">local</span> <span class="n">updatedTTL</span> <span class="o">=</span> <span class="n">currentTime</span> <span class="o">+</span> <span class="n">ttlOffset</span>

<span class="c1">-- Scan the ZSET for matching conversation ID</span>
<span class="kd">local</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZRANGEBYSCORE'</span><span class="p">,</span> <span class="s2">"UniqueSession:"</span> <span class="o">..</span><span class="n">id</span><span class="p">,</span> <span class="s1">'-inf'</span><span class="p">,</span> <span class="s1">'+inf'</span><span class="p">,</span> <span class="s1">'WITHSCORES'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">elements</span><span class="p">,</span> <span class="mi">2</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="kd">local</span> <span class="n">score</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">userID</span> <span class="o">..</span> <span class="s2">":"</span> <span class="o">..</span> <span class="n">product</span> <span class="o">..</span> <span class="s2">":preordered"</span> <span class="k">then</span>
        <span class="kd">local</span> <span class="n">updatedEntry</span> <span class="o">=</span> <span class="nb">string.gsub</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s2">":preordered$"</span><span class="p">,</span> <span class="s2">":udpated"</span><span class="p">)</span>
        <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZREM'</span><span class="p">,</span> <span class="s2">"UniqueSession:"</span> <span class="o">..</span><span class="n">id</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="c1">-- Add to ZSET with the new value and TTL</span>
        <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZADD'</span><span class="p">,</span> <span class="s2">"UniqueSession:"</span> <span class="o">..</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedTTL</span><span class="p">,</span> <span class="n">updatedEntry</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updatedEntry</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>Such Lua scripts are compacted and transferred to Redis Data Node based on the key distribution and are cached for future invocations.</p><p>As a result all commands in a single script are invoked locally on Redis Node given a big boost in performance and removing any additional network overhead for each command round trip.</p><p>With such technic Lua can add additional performance improvement to already existing Elastic Cache Redis mode.</p><h2 id="common-pitfalls"><span class="me-2">Common Pitfalls</span><a href="#common-pitfalls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The script can be executed only on a Single Node. So if you are using Redis in cluster mode (not a single node mode), then Redis master node should make decision on which node the key is located and will submit script to be executed on that node, following Data locality principle.</p><p>So, key should not be generated inside the Lua script at runtime, it should be available at invocation moment, otherwise you will receive error:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">(</span>error<span class="o">)</span> ERR Error running script <span class="o">(</span>call to f_c9b97033a0d4103dab472899949f376aedcf9242<span class="o">)</span>: @user_script:11: @user_script: 11: Lua script attempted to access a non <span class="nb">local </span>key <span class="k">in </span>a cluster node
</pre></table></code></div></div><h2 id="micro-optimisations"><span class="me-2">Micro optimisations</span><a href="#micro-optimisations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Redis REM, ADD commands can be executed as a single command</ul><div class="language-lua highlighter-rouge"><div class="code-header"> <span data-label-text="Lua"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">local</span> <span class="n">zaddArgs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1">-- Fill zaddArgs with data, then invoke with a single command</span>
<span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'ZADD'</span><span class="p">,</span> <span class="n">keyID</span><span class="p">,</span> <span class="n">unpack</span><span class="p">(</span><span class="n">zaddArgs</span><span class="p">))</span>
</pre></table></code></div></div><ul><li>Scripts can be cached on a Redis side, and be executed using EVALSHA command by a hashcode ID</ul><h3 id="links"><span class="me-2">Links:</span><a href="#links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://redis.io/docs/latest/develop/interact/programmability/eval-intro/">https://redis.io/docs/latest/develop/interact/programmability/eval-intro/</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/aws/">aws</a>, <a href="/categories/elasticcache/">elasticcache</a>, <a href="/categories/redis/">redis</a>, <a href="/categories/lua/">lua</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/elasticcache/" class="post-tag no-text-decoration" >elasticcache</a> <a href="/tags/redis/" class="post-tag no-text-decoration" >redis</a> <a href="/tags/lua/" class="post-tag no-text-decoration" >lua</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Making%20Extremely%20Fast%20AWS%20Elastic%20Cache%20Redis%20with%20Lua%20-%20Engineer's%20Notes&url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2025%2F01%2F11%2Felastic-cache-lua.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Making%20Extremely%20Fast%20AWS%20Elastic%20Cache%20Redis%20with%20Lua%20-%20Engineer's%20Notes&u=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2025%2F01%2F11%2Felastic-cache-lua.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2025%2F01%2F11%2Felastic-cache-lua.html&text=Making%20Extremely%20Fast%20AWS%20Elastic%20Cache%20Redis%20with%20Lua%20-%20Engineer's%20Notes" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftsypuk.github.io%2Fposts%2F2025%2F01%2F11%2Felastic-cache-lua.html" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/2025/09/26/multiagnet-n8n-bedrock.html">Orchestrating AI multi-agent infrastructure with AWS Bedrock, OpenAI and n8n</a><li class="text-truncate lh-lg"> <a href="/posts/2025/07/20/elastic-cache-vector.html">Amazon ElastiCache Redis as a Vector Embeddings Storage for Semantic Search in AWS Community Blog posts</a><li class="text-truncate lh-lg"> <a href="/posts/2025/09/17/duckdb-s3.html">Running analytics queries from your machine with Zero-BigData stack needed on top of AWS S3(compressed JSON, Parquet, csv) or other DataSources</a><li class="text-truncate lh-lg"> <a href="/posts/2023/10/02/dynamo-design.html">DynamoDB Table Design Principles - NoSQL Modeling</a><li class="text-truncate lh-lg"> <a href="/posts/2023/10/04/dynamo-one-to-many.html">DynamoDB Table Design Principles - One-To-Many Relationships in NoSQL</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/dynamodb/">dynamodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/s3/">s3</a> <a class="post-tag btn btn-outline-primary" href="/tags/ecs/">ecs</a> <a class="post-tag btn btn-outline-primary" href="/tags/network/">network</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli/">cli</a> <a class="post-tag btn btn-outline-primary" href="/tags/fargate/">fargate</a> <a class="post-tag btn btn-outline-primary" href="/tags/firehose/">firehose</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/2025/07/20/elastic-cache-vector.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1753020000" data-df="ll" > Jul 20, 2025 </time><h4 class="pt-0 my-2">Amazon ElastiCache Redis as a Vector Embeddings Storage for Semantic Search in AWS Community Blog posts</h4><div class="text-muted"><p>Abstract The AWS Community Builders program has produced an enormous trove of insightful blog content over the years. These posts, authored by community members across the globe, capture deep te...</p></div></div></a></article><article class="col"> <a href="/posts/2023/03/21/xra-tracing-2.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1679407200" data-df="ll" > Mar 21, 2023 </time><h4 class="pt-0 my-2">AWS XRAY tracing. Part 2: Advanced. Querying & Grouping.</h4><div class="text-muted"><p>Abstract Welcome to the next part of our AWS X-Ray series. Weâ€™ll explore the flow of trace detection and how to specify different parameters like time ranges. Additionally, weâ€™ll take a deep dive i...</p></div></div></a></article><article class="col"> <a href="/posts/2023/03/07/mingrammer.html" class="post-preview card h-100"><div class="card-body"> <time data-ts="1678165200" data-df="ll" > Mar 7, 2023 </time><h4 class="pt-0 my-2">Diagrams-as-a-Code DaC with Mingrammer for Public Cloud Providers and Agnostic Stacks.</h4><div class="text-muted"><p>Abstract During my analysis of open-source libraries that are suitable for rendering AWS components, in order to simplify the understanding and documenting of application architecture I discovered ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/2024/12/13/remote-debug-nodejs-with-ssm.html" class="btn btn-outline-primary" aria-label="Older" ><p>Remote Debugging/Profiling NodeJS app running in private ECS cluster using AWS SSM and inspect protocol</p></a> <a href="/posts/2025/03/17/yara-scanner.html" class="btn btn-outline-primary" aria-label="Newer" ><p>Cloud-Native Threat Detection: Deploying YARA for Scalable Malware Detection in EKS</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>Â© <time>2025</time> <a href="https://www.linkedin.com/in/roman-tsypuk">Roman Tsypuk</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span> <span data-bs-toggle="tooltip" data-bs-placement="top" title="2025-09-26 20:11:52 +0300 &#013;be60bb44e6416aa69b8fd68791db025be40c523c">Build version: be60bb4</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/dynamodb/">dynamodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/s3/">s3</a> <a class="post-tag btn btn-outline-primary" href="/tags/ecs/">ecs</a> <a class="post-tag btn btn-outline-primary" href="/tags/network/">network</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli/">cli</a> <a class="post-tag btn btn-outline-primary" href="/tags/fargate/">fargate</a> <a class="post-tag btn btn-outline-primary" href="/tags/firehose/">firehose</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'tsypuk/tsypuk.github.io', 'data-repo-id': 'R_kgDOIxaFiw', 'data-category': 'General', 'data-category-id': 'DIC_kwDOIxaFi84CUSfn', 'data-mapping': 'og:title', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'top', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
